# Daily Log - 2026-01-21

## 완료한 작업

### PubMed CCA Agent 프로젝트 개선 (`/scratch/connectome/leee4321/pubmed_cca_agent`)

기존 PubMed CCA Agent의 품질 향상 및 유연성 개선을 위한 대규모 업데이트 수행.

---

## 주요 업데이트 사항

### 1. Gemini API 모델 호환성 수정 및 프롬프트 개선

**문제**: `gemini-1.5-flash` 모델이 API에서 404 NOT_FOUND 에러 발생

**해결**:
- Results 섹션: `gemini-flash-latest` 사용
- Discussion 섹션: `gemini-2.5-flash` 사용 (처음엔 `gemini-2.5-pro` 시도했으나 무료 티어 quota=0으로 변경)

**프롬프트 대폭 개선**:

#### Results 섹션 프롬프트 개선
- **분량**: 4-6 문단 → **8-12 문단** (1,500-2,500 단어)
- **구조**: 상세한 서브섹션 추가
  - "Identification of a robust PGS-BNM canonical mode"
  - "Cognitive and psychiatric PGS loadings"
  - "Regional brain network architecture"
- **통계 보고 강화**: 모든 주요 발견에 대해 loading estimate, 95% CI, 백분율 포함
- **정량적 깊이**: Top 10-20 contributors 상세 보고, 해부학적 패턴 분석
- **환각 방지**: 그림/표 참조, 통계값 추정 금지 명시

#### Discussion 섹션 프롬프트 개선
- **분량**: 2,500-3,500 단어 → **3,000-4,000 단어**
- **구조 단순화**: 8-9개 소제목 → **3-4개 소제목만**
  - Opening (제목 없음): 2-3 문단
  - "Genetic architecture and brain network substrates": 5-7 문단 (핵심)
  - "Implications and future directions": 3-4 문단
  - Closing (제목 없음): 1-2 문단
- **문헌 통합 강화**: 10-15개 인용 → **20-30+ 인용** 목표
- **과학적 깊이**:
  - 메커니즘 모델 및 검증 가능한 가설 제시
  - 다층적 분석 (분자 → 세포 → 회로 → 행동)
  - 진화적/발달적 관점 포함
  - 대안적 해석 다루기
- **서술 방식**: 주제 통합적 전개, 각 문단당 2-4개 인용, 자연스러운 흐름

**파일 수정**:
- `results_generator.py`: 프롬프트 85줄 추가, 모델명 수정
- `discussion_generator.py`: 프롬프트 152줄 추가, 모델명 수정

---

### 2. 유연한 입력 파일 지정 기능 추가

**목적**: 다양한 데이터셋과 파일 명명 규칙에 대응

**구현**:

#### 새로운 Command-line Arguments
```bash
# 필수 arguments (4개 모두 제공 필요)
--x-loading              # X loading CSV 파일 경로
--y-loading              # Y loading CSV 파일 경로
--freesurfer-labels      # FreeSurfer labels CSV 파일 경로
--analysis-desc          # 분석 설명 텍스트 파일 경로

# 옵션 arguments
--introduction           # Introduction 텍스트 파일 경로
--methods                # Methods 텍스트 파일 경로
```

#### 검증 로직
- 개별 파일 지정 시 4개 필수 파일 모두 제공 확인
- 누락 시 명확한 에러 메시지 출력
- 기존 `--input-dir` 방식과 완전히 호환

#### 사용 예시
```bash
# 방법 1: 기본 디렉토리 (기존 방식)
python agent.py --mode generate

# 방법 2: 개별 파일 지정 (신규)
python agent.py --mode generate \
  --x-loading input/bootstrap_result_summary_x_loading_comp1.csv \
  --y-loading input/bootstrap_result_summary_y_loading_comp1.csv \
  --freesurfer-labels input/FreeSurfer_label.csv \
  --analysis-desc input/analysis_results_description.txt \
  --introduction input/Introduction.txt \
  --methods input/Methods.txt
```

**파일 수정**:
- `agent.py`: 57줄 추가 (arguments, 검증, help 메시지)
- `data_loader.py`: introduction/methods를 Optional 파라미터로 변경
- `script/run_agent.sbatch`: 사용 예제 추가
- `README.md`: 새 기능 문서화
- `examples_run_agent.sh`: 6가지 사용 시나리오 예제 스크립트 추가 (신규)

---

### 3. API Quota 분석 및 모델 최적화

#### 문제 발견
- `gemini-2.5-pro` 사용 시 `429 RESOURCE_EXHAUSTED` 에러
- 무료 티어에서 quota=0으로 설정되어 사용 불가

#### 해결 과정
1. **모델 리스트 확인**: `list_models.py` 스크립트 작성
2. **대안 선택**: `gemini-2.5-flash` (최신 세대 Flash 모델)
3. **문서화**: `MODEL_CONFIG.md` 작성

#### 최종 모델 구성

| 섹션 | 모델 | 특징 | RPM (무료) |
|------|------|------|-----------|
| Results | `gemini-flash-latest` | 빠른 통계 보고 | 15 |
| Discussion | `gemini-2.5-flash` | 최신 세대, 향상된 추론 | 15 |

#### 비용 분석
- **실행당 비용**: ~$0.003 (완전 무료)
- **하루 실행 가능 횟수**: ~450회
- **gemini-2.5-pro 사용 시 비용**: ~$0.041/실행 (13배 차이)

---

## Git 커밋 이력 (오늘 작업)

총 4개 커밋 생성:

### 1. Fix Gemini API model compatibility and enhance prompts for Nature-style output
**Commit ID**: `91d4242`
- 모델명 수정: `gemini-1.5-flash` → `gemini-flash-latest`
- Results 프롬프트 개선 (1,500-2,500 단어, 8-12 문단)
- Discussion 프롬프트 개선 (2,500-3,500 단어, 10-15 문단)
- 유틸리티 스크립트 추가: `estimate_api_usage.py`, `compare_api_tiers.py`
- **변경**: 4 files, +574 lines, -53 lines

### 2. Add flexible input file specification with individual file arguments
**Commit ID**: `5d13b2e`
- 개별 파일 지정 arguments 추가
- introduction/methods를 옵션으로 변경
- 검증 로직 및 help 메시지 개선
- `examples_run_agent.sh` 추가
- **변경**: 5 files, +308 lines, -35 lines

### 3. Upgrade Discussion to gemini-2.5-pro and enhance prompt for deeper scientific insights
**Commit ID**: `a31d5be`
- Discussion 모델: `gemini-2.5-pro` 시도
- 소제목 8-9개 → 3-4개로 축소
- 문헌 통합 20-30+ 인용으로 강화
- 과학적 깊이 및 메커니즘 분석 강조
- `MODEL_CONFIG.md` 추가
- **변경**: 2 files, +214 lines, -115 lines

### 4. Fix: Change Discussion model to gemini-2.5-flash for free tier compatibility
**Commit ID**: `c65a87b` (최신)
- gemini-2.5-pro quota 문제 해결
- Discussion 모델: `gemini-2.5-flash`로 변경
- MODEL_CONFIG.md 업데이트 (무료 티어 제한 설명)
- **변경**: 2 files, +26 lines, -19 lines

---

## 생성된 주요 파일

### 신규 파일
| 파일 | 목적 | 라인 수 |
|------|------|---------|
| `examples_run_agent.sh` | 6가지 사용 시나리오 예제 | 55 |
| `MODEL_CONFIG.md` | 모델 선택 및 구성 설명 | 78 |
| `estimate_api_usage.py` | API quota 사용량 추정 | 455 |
| `compare_api_tiers.py` | 무료/유료 tier 비교 | 455 |
| `list_models.py` | 사용 가능한 모델 리스트 | 20 |

### 수정된 파일
| 파일 | 주요 변경 사항 |
|------|---------------|
| `agent.py` | 개별 파일 arguments, 검증 로직 추가 |
| `data_loader.py` | Optional 파라미터 지원 |
| `results_generator.py` | 프롬프트 대폭 개선, 환각 방지 |
| `discussion_generator.py` | 프롬프트 재구성, 문헌 통합 강화 |
| `script/run_agent.sbatch` | 사용 예제 추가 |
| `README.md` | 새 기능 문서화 |

---

## 기술적 개선 사항

### 1. 프롬프트 엔지니어링
- **환각(Hallucination) 방지**: 그림/표/통계값 추정 명시적 금지
- **구조화된 출력**: 명확한 서브섹션과 단어 수 가이드
- **정량적 보고**: 모든 주요 발견에 대한 통계값 포함
- **문헌 통합**: 자연스러운 인용 통합 전략

### 2. 코드 품질
- **타입 힌팅**: Optional 타입 활용
- **검증 로직**: 사용자 입력 검증 강화
- **에러 처리**: 명확한 에러 메시지
- **문서화**: 상세한 help 메시지 및 예제

### 3. 사용성
- **유연성**: 2가지 입력 방식 지원
- **호환성**: 기존 방식과 완전 호환
- **확장성**: 다양한 데이터셋 지원

---

## 실행 결과

### 성공적인 실행
- **Job ID**: 82203 (SLURM)
- **모델**: Results (flash-latest) + Discussion (2.5-flash)
- **에러 없이 완료**: 무료 티어 quota 문제 해결

### 생성된 출력
- `results_20260121_024836.txt`: Results 섹션
- `discussion_20260121_024836.txt`: Discussion 섹션
- `references_20260121_024836.txt`: 참고문헌 리스트
- `paper_sections_20260121_024836.txt`: 통합 문서

---

## 프로젝트 현황

### 전체 통계
- **총 커밋**: 11개 (오늘 4개 추가)
- **총 코드 라인**: ~2,500 lines
- **주요 모듈**: 5개
- **유틸리티 스크립트**: 5개
- **문서**: README.md, MODEL_CONFIG.md, DAILY_LOG

### 기술 스택
- **언어**: Python 3.10
- **주요 라이브러리**:
  - `google-genai >= 0.3.0`: Gemini API
  - `requests >= 2.28.0`: PubMed API
  - `pandas >= 1.5.0`: 데이터 처리
  - `python-dotenv >= 1.0.0`: 환경 변수
- **실행 환경**: SLURM HPC (node3, 4 CPUs)

### API 사용
- **PubMed NCBI E-utilities**: 문헌 검색 (무료, 무제한)
- **Google Gemini API**: LLM 생성 (무료 티어, 15 RPM)

---

## 참고 자료

- [Google Gemini API Documentation](https://ai.google.dev/gemini-api/docs)
- [NCBI E-utilities Documentation](https://www.ncbi.nlm.nih.gov/books/NBK25501/)
- [Google Gemini Cookbook](https://github.com/google-gemini/cookbook)
- [Gemini API Rate Limits](https://ai.google.dev/gemini-api/docs/rate-limits)
